---
- name: Add the user 'jenkins'
  ansible.builtin.user:
    name: jenkins
    shell: /bin/bash

- name: Create .ssh directory for 'jenkins'
  ansible.builtin.file:
    path: /home/jenkins/.ssh
    state: directory
    owner: jenkins
    group: jenkins

- name: Generate ED25519 SSH Key for 'jenkins'
  community.crypto.openssh_keypair:
    path: "/home/jenkins/.ssh/id_ed25519"
    type: ed25519
    state: present
    owner: jenkins
    group: jenkins
    comment: "(Generated by Ansible)"

- name: Set authorized keys taken from GitHub
  ansible.posix.authorized_key:
    user: jenkins
    state: present
    key: https://github.com/deanpcmad.keys

- name: Generate ED25519 SSH Key for 'jenkins' used for connecting from Jenkins SSH
  community.crypto.openssh_keypair:
    path: "/home/jenkins/.ssh/id_ed25519_jenkins"
    type: ed25519
    state: present
    owner: jenkins
    group: jenkins
    comment: "Jenkins SSH (Generated by Ansible)"

- name: Get the contents of the Jenkins SSH key
  slurp:
    src: /home/jenkins/.ssh/id_ed25519_jenkins.pub
  register: jenkins_key

- name: Add Jenkins SSH generated SSH key to authorized keys
  ansible.posix.authorized_key:
    user: jenkins
    state: present
    key: "{{ jenkins_key['content'] | b64decode }}"
